<div class="p-4">
  <div class="w-full bg-blue-800 rounded-t-xl py-5 flex items-center justify-center my-4 shadow">
    <i class="pi pi-chart-bar text-2xl text-white mr-3"></i>
    <h2 class="text-2xl font-bold text-white tracking-tight text-center m-0">Gestión de Calificaciones</h2>
  </div>

  <!-- Tabs para alternar entre Consulta y Registro -->
  <p-tabView [(activeIndex)]="activeTab" *ngIf="isTeacher">
    <!-- TAB 1: CONSULTA DE CALIFICACIONES -->
    <p-tabPanel header="Consulta de Calificaciones">
      <!-- Contenido actual del formulario de búsqueda -->
      <div class="p-card p-4 mb-6 shadow-lg">
        <form (ngSubmit)="buscar()" class="flex flex-wrap gap-4 items-end">
          <div class="flex flex-col w-48">
            <label class="font-semibold mb-1">Estudiante ID</label>
            <input
              pInputText
              [(ngModel)]="filtros.student"
              name="student"
              placeholder="ID del estudiante"
              class="w-full" />
          </div>
          
          <div class="flex flex-col w-48">
            <label class="font-semibold mb-1">Materia</label>
            <p-dropdown
              [options]="subjects"
              optionLabel="name"
              optionValue="id"
              [(ngModel)]="filtros.subject"
              name="subject"
              placeholder="Todas las materias"
              [showClear]="true"
              class="w-full">
            </p-dropdown>
          </div>
          
          <div class="flex flex-col w-48">
            <label class="font-semibold mb-1">Curso</label>
            <p-dropdown
              [options]="courses"
              optionLabel="name"
              optionValue="id"
              [(ngModel)]="filtros.course"
              name="course"
              placeholder="Todos los cursos"
              [showClear]="true"
              class="w-full">
            </p-dropdown>
          </div>
          
          <div class="flex flex-col w-32">
            <label class="font-semibold mb-1">Nota mínima</label>
            <input
              pInputText
              type="number"
              [(ngModel)]="filtros.min_value"
              name="min_value"
              placeholder="Mínima"
              min="0"
              max="100"
              class="w-full" />
          </div>
          
          <div class="flex flex-col w-32">
            <label class="font-semibold mb-1">Nota máxima</label>
            <input
              pInputText
              type="number"
              [(ngModel)]="filtros.max_value"
              name="max_value"
              placeholder="Máxima"
              min="0"
              max="100"
              class="w-full" />
          </div>
          
          <div class="flex flex-col w-48">
            <label class="font-semibold mb-1">Buscar</label>
            <input
              pInputText
              [(ngModel)]="filtros.search"
              name="search"
              placeholder="Buscar..."
              class="w-full" />
          </div>
          
          <div class="flex gap-2">
            <button pButton type="submit" label="Buscar" icon="pi pi-search" class="p-button-primary"></button>
            <button pButton type="button" label="Limpiar" icon="pi pi-filter-slash" class="p-button-secondary" 
                    (click)="limpiarFiltros()"></button>
          </div>
        </form>
      </div>

      <div class="p-card shadow-lg">
        <p-table
          [value]="calificaciones"
          [rows]="pageSize"
          [paginator]="true"
          [lazy]="true"
          [totalRecords]="totalRecords"
          (onPage)="onPageChange($event)"
          [loading]="loading"
          [rowsPerPageOptions]="[5, 10, 20, 50]"
          [first]="(currentPage-1) * pageSize"
          class="min-w-[700px]">
          <ng-template pTemplate="header">
            <tr class="bg-blue-800 text-white">
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Estudiante</th>
              <th class="px-4 py-2">Materia</th>
              <th class="px-4 py-2">Curso</th>
              <th class="px-4 py-2">Nota</th>
              <th class="px-4 py-2">Fecha</th>
              <th class="px-4 py-2 text-center">Acciones</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-calificacion>
            <tr>
              <td class="border px-4 py-2">{{ calificacion.id }}</td>
              <td class="border px-4 py-2">{{ calificacion.student_name }}</td>
              <td class="border px-4 py-2">{{ calificacion.subject_name }}</td>
              <td class="border px-4 py-2">{{ calificacion.course_name }}</td>
              <td class="border px-4 py-2">
                <span [ngClass]="{
                  'text-red-600 font-bold': calificacion.value < 51,
                  'text-yellow-600 font-bold': calificacion.value >= 51 && calificacion.value < 71,
                  'text-green-600 font-bold': calificacion.value >= 71
                }">
                  {{ calificacion.value }}
                </span>
              </td>
              <td class="border px-4 py-2">{{ calificacion.date | date:'dd/MM/yyyy' }}</td>
              <td class="border px-4 py-2 text-center">
                <div class="flex gap-2 justify-center">
                  <button pButton icon="pi pi-eye" class="p-button-rounded p-button-info p-button-sm"
                    (click)="verDetalleCalificacion(calificacion)" 
                    pTooltip="Ver detalle" tooltipPosition="top"></button>
                  <button pButton icon="pi pi-list" class="p-button-rounded p-button-success p-button-sm"
                    (click)="verHistorialCalificaciones(calificacion)" 
                    pTooltip="Historial completo" tooltipPosition="top"></button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center text-gray-400 py-4">
                No hay calificaciones para mostrar con los filtros actuales.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Modal de detalle de calificación individual -->
      <p-dialog [(visible)]="detalleModalVisible" [modal]="true" [closable]="true" [style]="{'width':'500px'}">
        <ng-template pTemplate="header">
          <div class="bg-gradient-to-r from-blue-800 via-blue-600 to-blue-400 py-4 px-6 rounded-t-2xl w-full">
            <h2 class="text-xl font-bold text-white text-center">Detalle de Calificación</h2>
          </div>
        </ng-template>
        <div class="p-6 bg-white/90 rounded-b-2xl" *ngIf="detalleCalificacion">
          <div class="grid grid-cols-2 gap-4">
            <div class="mb-4">
              <div class="font-semibold text-blue-900">ID:</div>
              <div>{{ detalleCalificacion.id }}</div>
            </div>
            <div class="mb-4">
              <div class="font-semibold text-blue-900">Estudiante:</div>
              <div>{{ detalleCalificacion.student_name }}</div>
            </div>
            <div class="mb-4">
              <div class="font-semibold text-blue-900">Materia:</div>
              <div>{{ detalleCalificacion.subject_name }}</div>
            </div>
            <div class="mb-4">
              <div class="font-semibold text-blue-900">Curso:</div>
              <div>{{ detalleCalificacion.course_name }}</div>
            </div>
            <div class="mb-4">
              <div class="font-semibold text-blue-900">Valor:</div>
              <div 
                [ngClass]="{
                  'text-red-600 font-bold': detalleCalificacion.value < 51,
                  'text-yellow-600 font-bold': detalleCalificacion.value >= 51 && detalleCalificacion.value < 71,
                  'text-green-600 font-bold': detalleCalificacion.value >= 71
                }">
                {{ detalleCalificacion.value }}
              </div>
            </div>
            <div class="mb-4">
              <div class="font-semibold text-blue-900">Fecha:</div>
              <div>{{ detalleCalificacion.date | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
          
          <div class="mb-4 col-span-2">
            <div class="font-semibold text-blue-900">Descripción:</div>
            <div class="mt-1 p-2 bg-gray-50 rounded">{{ detalleCalificacion.description || 'Sin descripción' }}</div>
          </div>
          
          <div class="mb-4 col-span-2">
            <div class="font-semibold text-blue-900">Observaciones:</div>
            <div class="mt-1 p-2 bg-gray-50 rounded">{{ detalleCalificacion.observations || 'Sin observaciones' }}</div>
          </div>
          
          <div class="flex justify-end mt-4">
            <button pButton type="button" label="Cerrar" class="p-button-secondary" (click)="detalleModalVisible=false"></button>
          </div>
        </div>
      </p-dialog>
      
      <!-- Modal de historial completo de calificaciones -->
      <p-dialog [(visible)]="historialModalVisible" [modal]="true" [closable]="true" 
        [style]="{'width':'80vw', 'max-width':'1000px'}" [draggable]="false" [resizable]="false">
        <ng-template pTemplate="header">
          <div class="bg-gradient-to-r from-blue-800 via-blue-600 to-blue-400 py-4 px-6 rounded-t-2xl w-full">
            <h2 class="text-xl font-bold text-white text-center">
              Historial Académico - {{ estudianteSeleccionado?.student_name || 'Estudiante' }}
            </h2>
          </div>
        </ng-template>
        
        <div class="p-6 bg-white/90 rounded-b-2xl">
          <div *ngIf="loadingHistorial" class="flex justify-center p-4">
            <i class="pi pi-spin pi-spinner text-blue-600 text-4xl"></i>
          </div>
          
          <div *ngIf="!loadingHistorial && historialCalificaciones.length === 0" class="text-center p-4 text-gray-500">
            No hay calificaciones registradas para este estudiante.
          </div>
          
          <div *ngIf="!loadingHistorial && historialCalificaciones.length > 0" class="mb-4">
            <!-- Acordeón por año -->
            <p-accordion>
              <p-accordionTab *ngFor="let ano of historialPorAno | keyvalue" 
                              [header]="'Año Académico ' + getAnoKey(ano)">
                
                <!-- TabView por período dentro del año -->
                <p-tabView>
                  <p-tabPanel *ngFor="let periodo of getPeriodos(ano.value)" 
                              [header]="getPeriodoKey(periodo)">
                    
                    <!-- Tabla de calificaciones del período -->
                    <div class="overflow-x-auto">
                      <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-blue-100">
                          <tr>
                            <th class="px-4 py-2 text-left">Materia</th>
                            <th class="px-4 py-2 text-left">Descripción</th>
                            <th class="px-4 py-2 text-center">Nota</th>
                            <th class="px-4 py-2 text-center">Fecha</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let calificacion of getPeriodoValue(periodo)" 
                              class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">{{ calificacion.subject_name || 'N/D' }}</td>
                            <td class="px-4 py-2">{{ calificacion.comment || 'Sin descripción' }}</td>
                            <td class="px-4 py-2 text-center">
                              <span class="px-2 py-1 rounded-full text-white" 
                                    [ngClass]="{
                                      'bg-red-500': calificacion.value < 51,
                                      'bg-yellow-500': calificacion.value >= 51 && calificacion.value < 71,
                                      'bg-green-500': calificacion.value >= 71
                                    }">
                                {{ calificacion.value }}
                              </span>
                            </td>
                            <td class="px-4 py-2 text-center">{{ calificacion.created_at | date:'dd/MM/yyyy' }}</td>
                          </tr>
                        </tbody>
                        <tfoot class="bg-gray-50">
                          <tr>
                            <td class="px-4 py-2 font-bold" colspan="2">Promedio del período:</td>
                            <td class="px-4 py-2 text-center font-bold" colspan="2">
                              <span class="px-3 py-1 rounded-full text-white"
                                    [ngClass]="{
                                      'bg-red-500': calcularPromedioNotas(getPeriodoValue(periodo)) < 51,
                                      'bg-yellow-500': calcularPromedioNotas(getPeriodoValue(periodo)) >= 51 && calcularPromedioNotas(getPeriodoValue(periodo)) < 71,
                                      'bg-green-500': calcularPromedioNotas(getPeriodoValue(periodo)) >= 71
                                    }">
                                {{ calcularPromedioNotas(getPeriodoValue(periodo)) }}
                              </span>
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                    
                  </p-tabPanel>
                </p-tabView>
                
              </p-accordionTab>
            </p-accordion>
          </div>
          
          <div class="flex justify-end mt-6">
            <button pButton type="button" label="Cerrar" class="p-button-secondary" 
                    (click)="historialModalVisible=false"></button>
          </div>
        </div>
      </p-dialog>
    </p-tabPanel>
    
    <!-- TAB 2: REGISTRO DE CALIFICACIONES (solo visible para profesores) -->
    <p-tabPanel header="Registrar Calificación">
      <div class="p-card p-4 mb-6 shadow-lg">
        <h3 class="text-xl font-bold mb-4 text-green-800">Nueva Calificación</h3>
        
        <!-- Formulario para la búsqueda de estudiantes -->
        <form (ngSubmit)="onBuscarClick()" class="flex flex-wrap items-end gap-4 p-4 pb-2">
          <!-- Campo de búsqueda -->
          <div class="flex-1 min-w-[300px]">
            <label class="font-semibold text-gray-700 mb-1 block">
              Buscar estudiante <i class="pi pi-search text-blue-700 ml-2"></i>
            </label>
            <span class="p-input-icon-left w-full">
              <i class="pi pi-search text-blue-700"></i>
              <input
                pInputText
                [(ngModel)]="filtrosRegistro.search"
                name="search"
                placeholder="Nombre, ID, S6, P6, etc."
                class="w-full rounded-lg border-2 border-blue-300 focus:border-blue-600"
              />
            </span>
          </div>
          
          <button
            pButton
            type="submit"
            label="Buscar"
            icon="pi pi-search"
            class="p-button-success px-5 h-12"
          ></button>
        </form>
        
        <!-- Campos adicionales para el registro de calificación -->
        <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Campo de Curso -->
          <div>
            <label class="font-semibold text-gray-700 mb-1 block">
              Curso <span class="text-red-500">*</span>
            </label>
            <p-dropdown
              [options]="courses"
              [(ngModel)]="filtrosRegistro.course"
              optionLabel="name"
              optionValue="id"
              placeholder="Seleccione un curso"
              [showClear]="true"
              styleClass="w-full"
            ></p-dropdown>
          </div>
          
          <!-- Campo de Materia -->
          <div>
            <label class="font-semibold text-gray-700 mb-1 block">
              Materia <span class="text-red-500">*</span>
            </label>
            <p-dropdown
              [options]="subjects"
              [(ngModel)]="filtrosRegistro.subject"
              optionLabel="name"
              optionValue="id"
              placeholder="Seleccione una materia"
              [showClear]="true"
              styleClass="w-full"
            ></p-dropdown>
          </div>
          
          <!-- Campo de Título/Comentario -->
          <div>
            <label class="font-semibold text-gray-700 mb-1 block">
              Título de la Calificación <span class="text-red-500">*</span>
            </label>
            <input
              pInputText
              [(ngModel)]="filtrosRegistro.comment"
              placeholder="Ej: Examen Parcial, Tarea 1, etc."
              class="w-full"
            />
          </div>
          
          <!-- Campo de Periodo -->
          <div>
            <label class="font-semibold text-gray-700 mb-1 block">
              Periodo <span class="text-red-500">*</span>
            </label>
            <p-dropdown
              [options]="[
                {label: 'Periodo 2024', value: 1},
                {label: 'Periodo 2025', value: 2}
              ]"
              [(ngModel)]="filtrosRegistro.period"
              placeholder="Seleccione un periodo"
              [showClear]="false"
              styleClass="w-full"
            ></p-dropdown>
          </div>
        </div>
        
        <!-- Tabla de estudiantes -->
        <div class="mt-4" *ngIf="estudiantes.length > 0">
          <p-table [value]="estudiantes" [loading]="loadingEstudiantes">
            <ng-template pTemplate="header">
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th class="text-center">Calificación (0-100)</th>
                <th class="text-center">Acción</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-estudiante>
              <tr>
                <td>{{ estudiante.student_id }}</td>
                <td>{{ estudiante.full_name }}</td>
                <td class="text-center">
                  <!-- Solo visible si no está registrado -->
                  <div *ngIf="!estaRegistrado(estudiante)" class="flex justify-center">
                    <input
                      pInputText
                      type="number"
                      [(ngModel)]="notasEstudiantes[estudiante.user_id]"
                      placeholder="0-100"
                      min="0"
                      max="100"
                      class="w-20 text-center"
                    />
                  </div>
                  
                  <!-- Si ya está registrado, mostrar la nota -->
                  <span *ngIf="estaRegistrado(estudiante)" 
                        [ngClass]="{
                          'text-red-600 font-bold': notasRegistradas[estudiante.user_id] < 51,
                          'text-yellow-600 font-bold': notasRegistradas[estudiante.user_id] >= 51 && notasRegistradas[estudiante.user_id] < 71,
                          'text-green-600 font-bold': notasRegistradas[estudiante.user_id] >= 71
                        }">
                    {{ notasRegistradas[estudiante.user_id] }}
                  </span>
                </td>
                <td class="text-center">
                  <!-- Si no está registrado, mostrar botones -->
                  <div *ngIf="!estaRegistrado(estudiante)" class="flex justify-center">
                    <button pButton type="button" 
                      icon="pi pi-save" 
                      class="p-button-success p-button-sm"
                      pTooltip="Guardar calificación"
                      tooltipPosition="top"
                      [disabled]="!notasEstudiantes[estudiante.user_id] || notasEstudiantes[estudiante.user_id] < 0 || notasEstudiantes[estudiante.user_id] > 100"
                      (click)="registrarCalificacion(estudiante)"></button>
                  </div>
                  
                  <!-- Si ya está registrado, mostrar mensaje -->
                  <span *ngIf="estaRegistrado(estudiante)" class="text-green-600 font-semibold">
                    <i class="pi pi-check-circle mr-2"></i> Registrado
                  </span>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="4" class="text-center py-4">
                  No hay estudiantes disponibles.
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>

  <!-- Si no es profesor, mostrar solo la sección de consulta -->
  <div *ngIf="!isTeacher">
    <!-- Contenido actual del formulario de búsqueda -->
    <div class="p-card p-4 mb-6 shadow-lg">
      <!-- Contenido actual del formulario -->
      <!-- ... -->
    </div>
    <!-- Tabla de resultados actual -->
    <!-- ... -->
  </div>
  
  <!-- Modales existentes de detalle y historial -->
  <!-- ... -->
</div>
