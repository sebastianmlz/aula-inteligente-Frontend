<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Gestión de Asignaciones</h2>
    <button pButton type="button" icon="pi pi-plus" label="Agregar asignación"
      class="p-button-success" (click)="abrirModalCrear()"></button>
  </div>

  <div class="p-card p-4 mb-6 shadow-lg">
    <form (ngSubmit)="buscar()" class="flex flex-wrap gap-4 items-end">
      <div class="flex flex-col w-56">
        <label class="font-semibold mb-1">Docente</label>
        <p-dropdown
          [options]="teachers"
          optionLabel="user_full_name"
          optionValue="user_id"
          [(ngModel)]="filtros.teacher"
          name="teacher"
          placeholder="Todos los docentes"
          [showClear]="true"
          class="w-full">
        </p-dropdown>
      </div>
      <div class="flex flex-col w-56">
        <label class="font-semibold mb-1">Materia</label>
        <p-dropdown
          [options]="subjects"
          optionLabel="name"
          optionValue="id"
          [(ngModel)]="filtros.subject"
          name="subject"
          placeholder="Todas las materias"
          [showClear]="true"
          class="w-full">
        </p-dropdown>
      </div>
      <div class="flex flex-col w-56">
        <label class="font-semibold mb-1">Curso</label>
        <p-dropdown
          [options]="courses"
          optionLabel="name"
          optionValue="id"
          [(ngModel)]="filtros.course"
          name="course"
          placeholder="Todos los cursos"
          [showClear]="true"
          class="w-full">
        </p-dropdown>
      </div>
      <div class="flex flex-col w-48">
        <label class="font-semibold mb-1">Buscar</label>
        <input
          pInputText
          [(ngModel)]="filtros.search"
          name="search"
          placeholder="Buscar..."
          class="w-full" />
      </div>
      <div>
        <button pButton type="submit" label="Buscar" icon="pi pi-search" class="p-button-primary"></button>
      </div>
    </form>
  </div>

  <div class="p-card shadow-lg">
    <p-table
      [value]="asignaciones"
      [rows]="pageSize"
    [paginator]="true"
    [lazy]="true"
    [totalRecords]="totalRecords"
    (onPage)="onPageChange($event)"
    [loading]="loading"
    [rowsPerPageOptions]="[5, 10, 20, 50]"
    [first]="(currentPage-1) * pageSize"
    class="min-w-[700px]">
      <ng-template pTemplate="header">
        <tr>
          <th>Docente</th>
          <th>Materia</th>
          <th>Curso</th>
          <th>Periodo</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-a>
        <tr>
          <td>{{ a.teacher_details?.user_full_name || a.teacher?.details?.user_full_name }}</td>
          <td>{{ a.subject_name }}</td>
          <td>{{ a.course_name }}</td>
          <td>{{ a.period_name }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4" class="text-center text-gray-400">No hay asignaciones para mostrar.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog [(visible)]="crearModalVisible" [modal]="true" [closable]="true" [style]="{'width':'430px'}">
    <ng-template pTemplate="header">
      <span class="font-bold">Nueva Asignación</span>
    </ng-template>
    <form class="flex flex-col gap-4 py-2 px-1" (ngSubmit)="crearAsignacion()" #asignacionForm="ngForm">
      <p-dropdown
        [options]="teachers"
        optionLabel="user_full_name"
        optionValue="user_id"
        [(ngModel)]="nuevaAsignacion.teacher"
        name="teacher"
        placeholder="Seleccione docente"
        required
        class="w-full">
      </p-dropdown>
      <p-dropdown
        [options]="subjects"
        optionLabel="name"
        optionValue="id"
        [(ngModel)]="nuevaAsignacion.subject"
        name="subject"
        placeholder="Seleccione materia"
        required
        class="w-full">
      </p-dropdown>
      <p-dropdown
        [options]="courses"
        optionLabel="name"
        optionValue="id"
        [(ngModel)]="nuevaAsignacion.course"
        name="course"
        placeholder="Seleccione curso"
        required
        class="w-full">
      </p-dropdown>
      <input
        pInputText
        [(ngModel)]="nuevaAsignacion.period"
        name="period"
        placeholder="ID de periodo"
        required
        class="w-full" />
      <div class="flex items-center gap-2">
        <label class="font-semibold">¿Es primaria?</label>
        <p-checkbox [(ngModel)]="nuevaAsignacion.is_primary" name="is_primary" binary="true"></p-checkbox>
      </div>
      <div class="flex justify-end gap-2 mt-2">
        <button pButton type="button" label="Cancelar" class="p-button-secondary" (click)="crearModalVisible=false"></button>
        <button pButton type="submit" label="Guardar" class="p-button-success"></button>
      </div>
    </form>
  </p-dialog>
</div>
